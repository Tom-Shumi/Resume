# プロモーションメールのワンクリック購読解除機能開発プロジェクト

## 役割

- リードバックエンドエンジニア

## 使用技術

- Java
- Spring Boot
- KARTE
- Batch

## プロジェクト期間

- 3 ヶ月

## 開発手法

- アジャイル（スクラム）

## プロジェクト概要

Gmail のスパム判定が変更になった影響で、メールヘッダーにワンクリックで購読解除が行える URL を付与する必要があり、
上記に対応するために「ワンクリック購読解除用の API」「API のパラメータに付与するユーザ識別子生成バッチ」を開発しました。

## 開発手法

アジャイル（スクラム）

## 担当

- リードバックエンドエンジニア
  - 要求事項をもとにステークホルダーと要件を決める
  - アプリケーションの設計方針に対して責任を持つ
  - ソースコードの品質に対して責任を持つ

## 開発

### 課題

- ①：ワンクリック購読解除の「対象となるプロモーションメール」と「対象とならないトランザクションメール」の定義が曖昧だった。
- ②：メール配信の ON/OFF を管理するフラグが複数存在しており、メール配信フラグ : メール種別が 1 : n の関係となっていた。
  - メール配信フラグとメール種別の紐付けがドキュメント化されていなかった。
    - あるメール配信フラグを OFF にすることで配信停止になるメールがわからない状態だった。
- ③：「ワンクリック購読解除用の API」を認証せずに実行できる状態にしないといけなかった。
- ④：外部サービス（KARTE）経由でもメール配信を行なっており、外部サービス経由のメールにもメールヘッダーに「ワンクリック購読解除用の API」を設定する必要があった。
  - 外部サービス経由のメールにも認証不要で実行できる API の URL をメールヘッダーに設定する必要があった。

### 課題に対してやったこと

- 課題 ①②：
  - 「メール配信フラグとメール種別の紐付けがドキュメント化されていない」ということもあり、プロジェクトの最初にこれらの紐付けが把握できるドキュメントを作成しました。
    - ドキュメント作成の際は、開発チーム総動員でメール配信フラグごとに分担して、既存の実装をリバースエンジニアリングしました。
    - この時に作ったドキュメントが課題 ①② を解決するための判断材料になったため、プロジェクト初期にこの動きができたことは良かったと振り返っても思います。
- 課題 ③：
  - 認証せずにデータを更新する API を実行できるようにする必要があるため、リクエスト時にどのようなパラメータを渡すと良いのか、開発チームで時間をかけて議論しました。
    - 最終的にはユーザ ID のソルト付きハッシュにて対応することにしましたが、パラメータの不可逆性やハッシュの生成タイミングなど実際のユーザストーリーを考えて最適な方法をチームで検討しました。
- 課題 ④：
  - 外部サービス経由で送信するメールヘッダーにもユーザ ID のハッシュを付与する必要があるため、こちらも外部サービスへの連携タイミングや、どうやったら外部サービス運用担当者のオペレーションミスをできるだけ減らすことができるのか、実際に運用担当者と MTG を何回も行い、運用設計を行いました。

## 本プロジェクトの効果

本プロジェクトは守りのプロジェクトであり、本プロジェクトが成功したからといって事業的な数値が上がるわけではありませんでしたが、正しく実装・運用しないと今後 Gmail にメール送信ができなくなるかもしれないというリスクを抱えたプロジェクトでした。
結果的にリリース後に不具合もなく、これまでと変わらない運用が行えているため、プロジェクトとしては成功したと思っています。
